#!/usr/bin/env groovy

pipeline {
	agent any
	tools {
    }
	stages {
		stage('Create EMR') {
			steps{
				sh '''
				source ci/createcluster.sh
				'''
			}
		}
		stage('Setup') {
			steps{
				sh '''
				ssh -o StrictHostKeyChecking=no -i ~/.ssh/${KEYNAME}.pem hadoop@${DOMAIN} < ci/startup.sh
				'''
			}
		}
		stage('Test') {
			steps{
				sh '''
				ssh -o StrictHostKeyChecking=no -i ~/.ssh/${KEYNAME}.pem hadoop@${DOMAIN} < ci/runtests.sh
				'''
			}
		}
		stage('Terminate Cluster') {
			steps {
				aws emr terminate-clusters --cluster-ids ${CLUSTER_ID} --region ${REGION}
			}
		}
	}
}
